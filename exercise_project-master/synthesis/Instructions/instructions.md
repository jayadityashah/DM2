# Logic synthesis with Genus

This document describes a simple synthesis flow using Cadence Genus digital
synthesizer. Intention is to provide you means to simply test if your code is
synthesizable, and give you some idea what is needed to construct a synthesis
flow.

Most often the digital synthesizer tools are controlled with scripting, and
this is especially true for Cadence Genus. Therefore I have constructed this
simple flow for you instead of guiding you through GUI clicking, which actually
does to really work for Genus. GUI is mostly for debugging. 

First, I will describe the file structure so you get the big picture. 

## File structure
*  *sourceme.csh* provides you the tool setup for the synthesizer.  
*  *configure* defines the design specific parameters used by the flow. Running ``configure`` creates variable file *synthesize.tcl* which is the actual synthesis script that you can execute.
* *configure_includes/general_setups_include.sh* general setup script that configures the flow. Executed by *configure*. You do not need to edit this file.
* *configure_includes/process_setup_include.sh* process setup script that is included in configure. Sets up the semiconductor process for this synthesis flow. You do not need to edit this file. What it does:
    * Links process library 'Library Exchange Format' (LEF) library files to *flow/tech/lef/* directory
    * Links process library 'Liberty timing files' (.lib) files to *flow/tech/lib/* directory.
  These are then read in in the very first step of the flow setup.
* *constraints/mmmc_config.tcl* specifies the timing corners (voltage and temperature levels) to be used in the synthesis flow. Utilises the .lib files defined above. You do not need to edit this file on this course. However, you may study it's contents.
* *constraints/power_domains.cpf* defines the different supply voltage domains for the design. You do not need to edit this file on this course. You may study it's contents if you wish.
* *constraints/timing_constraints.sdc* **this file you must edit** it defines the timing constraints for your design. It contains simple self explanatory examples how to define clocks for your design. Those examples are sufficient information for the design you are doing on this course.


## Running the flow first time
This is an example that synthesizes a simple SPI from Verilog source using timing constraints defined in *constraints/timing_constraints.sdc*.

### Preparations
You should have a terminal session open and you should be in *synthesis* directory. I prefer having a terminal spit in two, so I can use the other split for Genus command line and the other split for Linux command line.

1. Run ``source sourceme.csh``
2. Run ``./configure``
3. Run ``genus --common_ui``

![Alt text](./Pics/Split_terminal.png?raw=true "Title")

### Running the low step-by-step.
Now you have Genus command line running (left split in my image)

1. In genus command line, run ``gui_show`` . The GUI opens, but it is empty.

![Alt text](./Pics/gui.png?raw=true "Title")

2. Open *synthesize.tcl* with your favourite text editor that is most likely
   gvim) ``gvim ./synthesize.tcl``. Text editor opens showing the following
   file (this is the top part of the file).  
   ![Alt text](./Pics/synthesize_tcl_top.png?raw=true "Title")

3. Select the line containing ``source ./flow/scripts/common_vars.tcl`` and
   paste it with middle button of the mouse to Genus GUI. Hit *return* once if
   the text you pasted does not contain a linebreak. You see some commands are
   executed. Those command are defined in *./flow/scripts/common_vars.tcl* that
   is generated by running ``configure``. Now you have variables defined.
   Nothing changed in the GUI.

4. Proceed copy-pasting the contents of the synthesis script *action by action*
(I.e. you should read the file and understand which part of it actually does
the action.). I will just tell you what to do. You should figure out the lines
to paste.
    * Read the timing libraries i.e. the mmmc-file.
    * Read the technology definition LEF file (i.e. routing layer rules).
    * Read the logic cell LEF file (i.e. the standard cell layouts).  You may
      get some warnigns, but as long as you do not get errors, you should be
      fine.
    * Read the if-clauses that read in the Verilog and VHDL. This is a handy
      costruct that reads the files in only if they are defined in the
      *configure* file on the lines depicted below. 

      ![Alt text](./Pics/vhdlfiles.png?raw=true "Title")

    So far nothing has really happened in the GUI

5.  Elaborate the design. Now you see that something happened in the GUI. You can open the *schematic* view of the design by clicking the ``+`` on the right side of text 'Layout' and choosing schematic.

    ![Alt text](./Pics/schematic.png?raw=true "Title")

    This is *elaborated desing* is is not yet synthesized, but the RTL is
    mapped to generic operators, like additions and registers and so forth.
    Now we are ready to got to the bottom part of the *syntesize.tcl*-file.
    
    ![Alt text](./Pics/synthesize_tcl_bot.png?raw=true "Title")

6. Initialize the design for synthesis. After issuing the command, you should look for this part
   ![Alt text](./Pics/read-sdc.png?raw=true "Title")

   There should be no errors. If there is, you should figure out what is wrong
   with *./constraints/timing_constraints.sdc*, fix it and re-run.

7. Then we are ready to do some mandatory pre-synthesis setups.
    *  Read the power intent. (defines the power domains)
    *  Clean up the cost groups and re-define them (used in timing analysis)subject line
    * Add the basic delay path groups-. Pay attention to those curly braces.
    * Set the interactive constraint mode. (This makes it possible to manually
      feed in timing constraint commands on Genus command line, outside the sdc file.)

8. Now we are ready for the actual synthesis.
    * Run ``syn_generic`` and save the database after it. This is the first
      step of mapping the general operations to logic gates.
    * Run ``syn_map`` and save the database. This actually maps the gates to
      *real* gates of logic library of the semiconductor process vendor.
    * Run ``syn_opt`` and save the database. This optimizes the implementation.

9. Then we are ready for reporting. 
    * Run all timing reports
    * Power reports.

    Study all the report files in *./reports/*-directory . *reports/timing.rpt* is the most important. It tells you if the timing constraints are met.

### Running the flow in batch mode
Most of the time you are changing  the *source code* and you want the resynthesize the design with constraints that you have defined before. You can achieve this by running

``genus -common_ui -batch -files synthesize.tcl``

After the flow has finished, you check the report files at *reports*-directory. Databases are saved in *dbs*-directory. If you want to check the resulting schematics, or debug the design with Genus:

*  Run *genus -common_ui*
*  Then in Genus command window
    * ``read_db dbs/syn_opt.db``
    * ``gui_show``
    * Open the schematic view.

### Getting help and debugging
You can open the manuals of Genus from the top right corner of the Genus GUI.

![Alt text](./Pics/help.png?raw=true "Title")

You can open the *library view* by clicking the small round icon with three lines inside. 

![Alt text](./Pics/help_with_library.png?raw=true "Title")

The *search* feature of the help is the most useful one. If you click open the *genus* menu, you see all Genus-related documentation.

![Alt text](./Pics/Genus_manuals.png?raw=true "Title")

The reason why a comprehensive guide for everything you can do with Genus is
not provided on this course is simply the following: *it is impossible* . The
situation you most often encounter with any digital tool is that you have a
problem and thousands of pages of manual. Here it is. :)  

#### Some pointers (i.e. subsections of the manual) to information you may need.
   *  Specifying timing and design constraints.
   *  Input Output delays
   *  Specifying optimization constraints
   






